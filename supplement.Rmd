---
title: "Supplement of 'Optimizing Position Finding and Accuracy of wildlife movement
data using the trackIT Automated Radiotelemetry System'"
author: "Mirjam R. Rieger, Jan Schmitt, Paula Machin, Johann Musculus, Ralf Dittrich,
Thomas K. Gottschalk, Jannis Gottwald, Patrick Lampe, Jonas HÃ¶chst"
bookdown::html_document2:
  number_sections: true
  toc_depth: 2
always_allow_html: true
language: eng
fontsize: 12pt
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.width = 10, fig.height = 4)
library(kableExtra)
```

# Methods

## Ground truth data
```{r}
# Properties of test tracks used to compare position estimations and accuracies for maisC (C1-4) and maisD (D1-
# 4). N points is the number of recorded GPS positions (summarized in 2-second intervals) and N tags the number of used
# transmitters.

colnames(sum.p)[colnames(sum.p) %in% c("trackID", "duration_h", "length_km")] <- c("track ID", "duration (h)", "length (km)") 

kable(sum.p,
             caption = "Properties of test tracks used to compare position estimations and accuracies for maisC (C1-4) and maisD (D1-4). N points is the number of recorded GPS positions (summarized in 2-second intervals) and N tags the number of used
transmitters.",
      row.names = F,
      escape = FALSE,
      align = c("llrrrr")) %>%
  row_spec(which(1:nrow(sum.p)%%2!=1),
           background = "#CCCCCC") %>%
  kable_styling(font_size = 12, latex_options = "hold_position") %>%
  row_spec(0, extra_css = "border-bottom: 1px solid black;", background = "#CCCCCC") %>%
  row_spec(4, extra_css = "border-bottom: 1px solid black;") %>%
  row_spec(8, extra_css = "border-bottom: 1px solid black;")

```

## Station cover
```{r, fig.cap = "Exemplified calculation of detection probability (left) and station cover (summed up detection probabilities across all stations, right) for directional antennas in maisC. Copyright map data: OpenStreetMap contributors"}
## plot example for methods
shp.circ <- shp.circ[order(shp.circ$dens),]
g1 <- ggplot() + 
  annotation_map_tile(type = "osm") +
  geom_sf(aes(fill = dens), color = NA, 
          data = shp.circ[shp.circ$station == "c1l1",], lwd = 2) + 
  geom_sf(data = df.stat[df.stat$station.id == "c1l1",], pch = 23, 
          fill = "white", color = "black", stroke = 1.2, size = 3, alpha = 0.7) + 
  scale_fill_viridis_c("detection \nprobability", direction = -1, option = "rocket", 
                       end = 0.9, alpha = 0.4, breaks = c(0.1, 0.25, 0.4, 0.55, 0.7, 0.85, 1)) +
  annotation_scale(height = unit(0.4, "cm"), text_cex = 1, width_hint = 0.4, bar_cols = c("grey60", "white")) +
  facet_wrap(~ "1 station") +
  theme_void(base_size = 15) +
  theme(legend.position = "none",
        strip.background = element_rect(fill = "grey60", color = "grey60"),
        strip.text = element_text(size = 15, colour="white"))

g2 <- ggplot() + 
  annotation_map_tile(type = "osm") +
  geom_sf(aes(fill = dens), color = NA, 
          data = shp.circ[shp.circ$station %in% c("c1l1", "c2l1"),], lwd = 2) + 
  geom_sf(data = df.stat[df.stat$station.id %in% c("c1l1", "c2l1"),], pch = 23, 
          fill = "white", color = "black", stroke = 1.2, size = 3, alpha = 0.7) + 
  scale_fill_viridis_c("detection \nprobability", direction = -1, option = "rocket", 
                       end = 0.9, alpha = 0.4, breaks = c(0.1, 0.25, 0.4, 0.55, 0.7, 0.85, 1)) +
  annotation_scale(height = unit(0.4, "cm"), text_cex = 1, width_hint = 0.4, bar_cols = c("grey60", "white")) +
  facet_wrap(~ "2 stations") +
  theme_void(base_size = 15) +
  theme(legend.position = "right",
        strip.background = element_rect(fill = "grey60", color = "grey60"),
        strip.text = element_text(size = 15, colour="white"))


## plot raster (= merged polygons)
gC <- ggplot(shp.r) +
  annotation_map_tile(type = "osm") +
  geom_sf(aes(fill = dens, color = dens)) +
  scale_fill_viridis_c("station cover", direction = -1, option = "rocket", na.value = NA, limits = c(0.1, NA), end = 0.9) +
  scale_color_viridis_c("station cover", direction = -1, option = "rocket", na.value = NA, limits = c(0.1, NA), end = 0.9) +
  annotation_map_tile(type = "osm", alpha = 0.2) +

  new_scale_fill() +
  
  geom_sf(data = df.stat[df.stat$station.project_id == "maisC" & df.stat$type == "direct",], 
          aes(pch = type, fill = type), color = "black", stroke = 1.2, size = 3, alpha = 0.7) +
  scale_shape_manual("station type", values = c("direct" = 23, "omni" = 21),
                     guide = guide_legend(order = 2)) +
  scale_fill_manual("station type", values = c("direct" = "white", "omni" = "grey60"),
                    guide = guide_legend(order = 2)) +
  # geom_sf(data = df[100000:100100,], pch = 1, color = "grey80", alpha = 0.5) + # check whether dimensions are correct
  coord_sf(xlim = c(dimC2[1], dimC2[3]), ylim = c(dimC2[2], dimC2[4]), expand = F) +
  annotation_scale(height = unit(0.4, "cm"), text_cex = 1, width_hint = 0.4, bar_cols = c("grey60", "white")) +
  facet_wrap(~"maisC") +
  theme_void(base_size = 15) +
  theme(legend.position = "right",
        strip.background = element_rect(fill = "grey60", color = "grey60"),
        strip.text = element_text(size = 15, colour="white"))

gD <- ggplot(shp.r) +
  annotation_map_tile(type = "osm") +
  geom_sf(aes(fill = dens, color = dens), lwd = 0.1) +
  scale_fill_viridis_c("station cover", direction = -1, option = "rocket", na.value = NA, limits = c(0.1, NA), end = 0.9) +
  scale_color_viridis_c("station cover", direction = -1, option = "rocket", na.value = NA, limits = c(0.1, NA), end = 0.9) +
  
  new_scale_fill() +
  
  geom_sf(data = df.stat[df.stat$station.project_id == "maisD" & df.stat$type == "direct",], 
          aes(pch = type, fill = type), color = "black", stroke = 1.2, size = 3, alpha = 0.7) +
  scale_shape_manual("station type", values = c("direct" = 23, "omni" = 21),
                     guide = guide_legend(order = 2)) +
  scale_fill_manual("station type", values = c("direct" = "white", "omni" = "grey60"),
                    guide = guide_legend(order = 2)) +
  # geom_sf(data = df[100000:100100,], pch = 1, color = "grey80", alpha = 0.5) + # check whether dimensions are correct
  coord_sf(xlim = c(dimD2[1], dimD2[3]), ylim = c(dimD2[2], dimD2[4]), expand = F) +
  annotation_scale(height = unit(0.4, "cm"), text_cex = 1, width_hint = 0.4, bar_cols = c("grey60", "white")) +
  facet_wrap(~"maisD") +
  theme_void(base_size = 15) +
  theme(legend.position = "none",
        strip.background = element_rect(fill = "grey60", color = "grey60"),
        strip.text = element_text(size = 30, colour="white"))

g <- gC + gD
g <- g1 + g2 + gC

g
```

# Results

## Correlations between predictors {.tabset}


```{r}
## helper functions for pairs()
panel.hist <- function(x, ...) {
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5))
  his <- hist(x, plot = FALSE)
  breaks <- his$breaks
  nB <- length(breaks)
  y <- his$counts
  y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, col = "grey", ...)
  # lines(density(x), col = 2, lwd = 2) # Uncomment to add density lines
}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...) {
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  Cor <- abs(cor(x, y)) # Remove abs function if desired
  txt <- paste0(prefix, format(c(Cor, 0.123456789), digits = digits)[1])
  if(missing(cex.cor)) {
    cex.cor <- 0.4 / strwidth(txt)
  }
  text(0.5, 0.5, txt,
       cex = 1 + cex.cor * Cor) # Resize the text by level of correlation
}

panel.point <- function(x, y) {
  points(x, y, col = adjustcolor("black", alpha.f = 0.01), pch = 1)
}
```

### direct ab - maisC
```{r, fig.cap = "Correlations between predictors, including correlation coefficients (upper panels) and histograms (diagonal panels) for directional antenna beams in maisC.", fig.width = 10, fig.height = 5}
df <- df.m4[df.m4$meth == "direct.ab" & df.m4$site == "maisC", c("Ac", "Sc", "cover", "maxSig", "Weight")]
pairs(df, upper.panel = panel.cor, diag.panel = panel.hist, lower.panel = panel.point)
```

### direct ab - maisD
```{r, fig.cap = "Correlations between predictors, including correlation coefficients (upper panels) and histograms (diagonal panels) for directional antenna beams in maisD.", fig.width = 10, fig.height = 5}
df <- df.m4[df.m4$meth == "direct.ab" & df.m4$site == "maisD", c("Ac", "Sc", "cover", "maxSig", "Weight")]
pairs(df, upper.panel = panel.cor, diag.panel = panel.hist, lower.panel = panel.point)
```

### direct in - maisC
```{r, fig.cap = "Correlations between predictors, including correlation coefficients (upper panels) and histograms (diagonal panels) for directional intersection in maisC.", fig.width = 10, fig.height = 5}
df <- df.m4[df.m4$meth == "direct.in" & df.m4$site == "maisC", c("Sc", "cover", "maxSig")]
pairs(df, upper.panel = panel.cor, diag.panel = panel.hist, lower.panel = panel.point)
```

### direct in - maisD
```{r, fig.cap = "Correlations between predictors, including correlation coefficients (upper panels) and histograms (diagonal panels) for directional intersection in maisD.", fig.width = 10, fig.height = 5}
df <- df.m4[df.m4$meth == "direct.in" & df.m4$site == "maisD", c("Sc", "cover", "maxSig")]
pairs(df, upper.panel = panel.cor, diag.panel = panel.hist, lower.panel = panel.point)
```

### omni ab - maisC
```{r, fig.cap = "Correlations between predictors, including correlation coefficients (upper panels) and histograms (diagonal panels) for omnidirectional antenna beams in maisC.", fig.width = 10, fig.height = 5}
df <- df.m4[df.m4$meth == "omni.ab" & df.m4$site == "maisC", c("Sc", "cover", "maxSig", "Weight")]
pairs(df, upper.panel = panel.cor, diag.panel = panel.hist, lower.panel = panel.point)
```

### omni ml - maisC
```{r, fig.cap = "Correlations between predictors, including correlation coefficients (upper panels) and histograms (diagonal panels) for omnidirectional multilateration in maisC.", fig.width = 10, fig.height = 5}
df <- df.m4[df.m4$meth == "omni.ml" & df.m4$site == "maisC", c("Sc", "cover", "maxSig")]
pairs(df, upper.panel = panel.cor, diag.panel = panel.hist, lower.panel = panel.point)
```


## Position error and accuracy {.tabset}


```{r}
plotPAdab <- function(d.pred, PApred, lower, upper, ytitle) {
  
  d.pred$PApred <- d.pred[,PApred]
  d.pred$lower <- d.pred[,lower]
  d.pred$upper <- d.pred[,upper]
  
  g <- ggplot(d.pred) + 
    geom_line(aes(x = Ac, y = PApred, group = Sc, color = Sc),
              lwd = 1, alpha = 0.5, position = position_dodge(width = 0.3)) + 
    geom_linerange(aes(x = Ac, y = PApred, ymin = lower, ymax = upper,
                        group = Sc, color = Sc),
              lwd = 1, alpha = 0.5, position = position_dodge(width = 0.3)) + 

    scale_color_viridis_d("Sc", option = "viridis") +
    facet_wrap(~paste0(meth, " - ", site), ncol = 2, strip.position = "top") +
    xlab("number of antennas") +
    ylab(ytitle) +
    # ylim(0, 500) +
    scale_x_continuous(breaks = c(4, 8, 12, 16, 20, 24, 28, 32)) +
    ylim(0, max(c(d.pred$upr, d.pred$uprq50, d.pred$uprq65), na.rm = T)) +
    theme_light(base_size = 16) +
    theme(strip.background = element_rect(fill = "grey60", color = "grey60"),
          strip.text = element_text(size = 15, colour="white"))  
  
  return(g)
  
}


plotPA <- function(d.sim, d.pred, PAsim, PApred, lower, upper, ytitle) {
  
  d.sim$PAsim <- d.sim[,PAsim]
  d.pred$PApred <- d.pred[,PApred]
  d.pred$lower <- d.pred[,lower]
  d.pred$upper <- d.pred[,upper]
  
  g <- ggplot(d.pred) + 

    geom_split_violin(aes(x = as.factor(Ac), y = PAsim, fill = Sc, color = Sc),
                      alpha = 0.4, trim = TRUE, scale = "count", width = 2, 
                      data = d.sim) +
    
    geom_point(aes(x = as.factor(Ac), y = PApred, group = Sc, color = Sc),
              size = 3.5, alpha = 0.8) + 
    geom_linerange(aes(x = as.factor(Ac), y = PApred, ymin = lower, ymax = upper,
                       group = Sc, color = Sc),
                   lwd = 1.5, alpha = 0.8) + 

    scale_color_viridis_d("Sc", option = "viridis") +
    scale_fill_viridis_d("Sc", option = "viridis") +
    facet_wrap(~ paste0(meth, " - ", site), ncol = 2, strip.position = "top") +
    xlab("number of antennas") +
    ylab(ytitle) +
    ylim(0, max(c(d.sim$sim.m, d.sim$sim.q50, d.sim$sim.q65), na.rm = T)) +
    theme_light(base_size = 16) +
    theme(strip.background = element_rect(fill = "grey60", color = "grey60"),
          strip.text = element_text(size = 15, colour="white"))
  
  return(g)
  
}
```


### PA

```{r, fig.cap = "Predicted PA from the global model, namely the estimated mean PE including 95 % CI (and density distribution, only in middle and bottom panels) for all present combinations of Ac-Sc per site and method. For predictions, maxSig, (weight) and cover were set to their respective raw data mean per Ac-Sc combination.", fig.height = 12}

g1 <- plotPAdab(d.pred = df.pred5[df.pred5$meth == "direct ab",], 
       PApred = "pred_mod", lower = "lwr", upper = "upr",
       ytitle = "mean est. PE (m) and 95% CI")

g2 <- plotPA(d.sim = df.sim5[df.sim5$meth == "direct in",], 
       d.pred = df.pred5[df.pred5$meth == "direct in",], 
       PAsim = "sim.m", PApred = "pred_mod", lower = "lwr", upper = "upr",
       ytitle = "mean est. PE (m) and 95% CI")

g3 <- plotPA(d.sim = df.sim5[df.sim5$meth %in% c("omni ab", "omni ml"),], 
       d.pred = df.pred5[df.pred5$meth %in% c("omni ab", "omni ml"),], 
       PAsim = "sim.m", PApred = "pred_mod", lower = "lwr", upper = "upr",
       ytitle = "mean est. PE (m) and 95% CI")

layout <- "
A
B
C
"

g <- g1 + g2 + g3 + plot_layout(design = layout)
g

```

### PA50

```{r, fig.cap = "Predicted PA50 from the global model, namely the estimated 50% quantile of PE including 95 % CI (and density distribution, only in middle and bottom panels) for all present combinations of Ac-Sc per site and method. For predictions, maxSig, (weight) and cover were set to their respective raw data mean per Ac-Sc combination.", fig.height = 12}

g1 <- plotPAdab(d.pred = df.pred5[df.pred5$meth == "direct ab",], 
       PApred = "q50", lower = "lwrq50", upper = "uprq50",
       ytitle = "q50 of est. PE (m) and 95% CI")

g2 <- plotPA(d.sim = df.sim5[df.sim5$meth == "direct in",], 
       d.pred = df.pred5[df.pred5$meth == "direct in",], 
       PAsim = "sim.q50", PApred = "q50", lower = "lwrq50", upper = "uprq50",
       ytitle = "q50 of est. PE (m) and 95% CI")

g3 <- plotPA(d.sim = df.sim5[df.sim5$meth %in% c("omni ab", "omni ml"),], 
       d.pred = df.pred5[df.pred5$meth %in% c("omni ab", "omni ml"),], 
       PAsim = "sim.q50", PApred = "q50", lower = "lwrq50", upper = "uprq50",
       ytitle = "q50 of est. PE (m) and 95% CI")

layout <- "
A
B
C
"

g <- g1 + g2 + g3 + plot_layout(design = layout)
g

```

### PA65

```{r, fig.cap = "Predicted PA65 from the global model, namely the estimated 65% quantile of PE including 95 % CI (and density distribution, only in middle and bottom panels) for all present combinations of Ac-Sc per site and method. For predictions, maxSig, (weight) and cover were set to their respective raw data mean per Ac-Sc combination.", fig.height = 12}

g1 <- plotPAdab(d.pred = df.pred5[df.pred5$meth == "direct ab",], 
       PApred = "q65", lower = "lwrq65", upper = "uprq65",
       ytitle = "q65 of est. PE (m) and 95% CI")

g2 <- plotPA(d.sim = df.sim5[df.sim5$meth == "direct in",], 
       d.pred = df.pred5[df.pred5$meth == "direct in",], 
       PAsim = "sim.q65", PApred = "q65", lower = "lwrq65", upper = "uprq65",
       ytitle = "q65 of est. PE (m) and 95% CI")

g3 <- plotPA(d.sim = df.sim5[df.sim5$meth %in% c("omni ab", "omni ml"),], 
       d.pred = df.pred5[df.pred5$meth %in% c("omni ab", "omni ml"),], 
       PAsim = "sim.q65", PApred = "q65", lower = "lwrq65", upper = "uprq65",
       ytitle = "q65 of est. PE (m) and 95% CI")

layout <- "
A
B
C
"

g <- g1 + g2 + g3 + plot_layout(design = layout)
g
```

