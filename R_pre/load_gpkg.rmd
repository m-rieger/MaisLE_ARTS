---
title: "Antenna beams"
output: bookdown::html_document2
---
<style>
.scroll6 {
    height: 600px;
    overflow-y: scroll;
    overflow-x: auto;
}
</style>

```{r setup, include = F}
## set global chunk options
knitr::opts_chunk$set(echo = FALSE, fig.width = 10, fig.height = 5, warning = F, message = F)

## packages
library(ggdist)
library(tidyverse)
library(sf)
library(data.table)

## variables
dtyp <- "animal" # "animal" or "testtag"
t <- "2 sec" # time intervall
t2 <- as.numeric(gsub(" sec", "", t))

## get path for plots
weight_error <- "./plots/weight_error.Rmd"
NoStat_error <- "./plots/NoStat_error.Rmd"


## get all gpkg files and merge them

if(dtyp == "animal") {
  
  df.L <- list.files("../../data/data_animal/", pattern = ".gpkg")

  for(i in df.L) {
    tmp <- st_read(paste0("../../data/data_animal/", i))
    
    tmp <- tmp %>%
      dplyr::mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2]) %>%
      st_drop_geometry()
    
    tmp <- full_join(tmp, 
                     data.frame(X_time = seq(from = min(tmp$X_time), 
                                             to = max(tmp$X_time), by = t)), 
                     by = c("X_time"))
    
    tmp <- tmp[order(tmp$X_time),]
    
    tmp$lon.r15 <- zoo::rollapply(tmp$lon, width = 15/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)
    tmp$lat.r15 <- zoo::rollapply(tmp$lat, width = 15/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)
    tmp$lon.r30 <- zoo::rollapply(tmp$lon, width = 30/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)
    tmp$lat.r30 <- zoo::rollapply(tmp$lat, width = 30/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)

    
    ggplot(tmp[1:300,]) +
      geom_point(aes(x = lon, y = lat), color = "grey") +
      geom_point(aes(x = lon.r15, y = lat.r15), color = "lightblue") +
      geom_point(aes(x = lon.r30, y = lat.r30), color = "blue")
    
    ggplot(tmp[1:300,]) +
      geom_point(aes(x = lon, y = lat, color = X_time), shape = 1) +
      geom_path(aes(x = lon, y = lat), color = "grey80", alpha = 0.5) +
      geom_point(aes(x = lon.r15, y = lat.r15, color = X_time), shape = 2) +
      geom_path(aes(x = lon.r15, y = lat.r15), color = "grey60", alpha = 0.5) +
      geom_point(aes(x = lon.r30, y = lat.r30, color = X_time), shape = 3) +
      geom_path(aes(x = lon.r30, y = lat.r30), color = "grey40", alpha = 0.5) +
      scale_color_viridis_c() +
      theme_light()
  
  
    ## write data
    write.csv(tmp, paste0("../../data/data_animal/", i, ".csv"), row.names = F)
            

  }  

}

if(dtyp == "testtag") {
  
  df.L <- list.files("../../data/data_testtag/", pattern = ".gpkg")

  for(i in df.L) {
    tmp <- st_read(paste0("../../data/data_testtag/", i))
    
    tmp <- tmp %>%
      dplyr::mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2]) %>%
      st_drop_geometry()
    
    tmp <- full_join(tmp, 
                     data.frame(X_time = seq(from = min(tmp$X_time), 
                                             to = max(tmp$X_time), by = t)), 
                     by = c("X_time"))
    
    tmp <- tmp[order(tmp$X_time),]
    
    tmp$lon.r15 <- zoo::rollapply(tmp$lon, width = 15/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)
    tmp$lat.r15 <- zoo::rollapply(tmp$lat, width = 15/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)
    tmp$lon.r30 <- zoo::rollapply(tmp$lon, width = 30/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)
    tmp$lat.r30 <- zoo::rollapply(tmp$lat, width = 30/t2, FUN = mean, fill = NA, na.rm = T, partial = TRUE)

    
    ggplot(tmp[1:300,]) +
      geom_point(aes(x = lon, y = lat), color = "grey") +
      geom_point(aes(x = lon.r15, y = lat.r15), color = "lightblue") +
      geom_point(aes(x = lon.r30, y = lat.r30), color = "blue")
    
    ggplot(tmp[1:5000,]) +
      # geom_path(aes(x = Longitude.Calibration, y = Latitude.Calibration), color = "black", alpha = 0.5) +
      geom_point(aes(x = lon, y = lat, color = X_time), shape = 1) +
      geom_path(aes(x = lon, y = lat), color = "grey80", alpha = 0.5) +
      geom_point(aes(x = lon.r15, y = lat.r15, color = X_time), shape = 2) +
      geom_path(aes(x = lon.r15, y = lat.r15), color = "grey60", alpha = 0.5) +
      geom_point(aes(x = lon.r30, y = lat.r30, color = X_time), shape = 3) +
      geom_path(aes(x = lon.r30, y = lat.r30), color = "grey40", alpha = 0.5) +
      scale_color_viridis_c() +
      theme_light()
  
  
    ## write data
    write.csv(tmp, paste0("../../data/data_testtag/", i, ".csv"), row.names = F)
            

  }  

}


```


